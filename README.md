# internship_project

## Умный генератор коммерческих предложений 

## Архитектуа решения задачи 
### Общая схема компонентов 
   * API Gateway (FastAPI / Swagger) — единая точка входа (загрузка писем, PDF, текстовых запросов).
   * LLM-Agent (Оркестратор) — анализирует входящий запрос, классифицирует тип (текст, документ, скан), определяет, какие воркеры активировать.
   * Воркеры: 
       * Parser Worker — извлекает данные из PDF/Email (контактные данные, запрос клиента, продуктовые параметры).
       * Offer Worker — формирует КП (цены, описание, форматирование, структура).
       * Validation Worker — проверяет КП на соответствие бизнес-правилам и шаблонам.
   * Storage:
       * DB (PostgreSQL) — хранит заявки, параметры, версии КП и историю ревизий.
       * File Storage (S3 / MinIO) — хранит оригинальные вложения и итоговые документы КП (PDF/DOCX).

### Потоки данных
   * Клиент отправляет письмо / загружает файл → POST /submit.

   * API Gateway валидирует и сохраняет данные → создаёт задачу (status=RECEIVED).

   * LLM-Agent анализирует payload → определяет тип контента (text, pdf, email, scan).

   * Агент публикует задачу в соответствующую очередь (jobs.parser, jobs.offer, jobs.validation).

   * Воркеры обрабатывают задачу, сохраняют промежуточные и финальные результаты.

   * Клиент/менеджер запрашивает /result/{task_id} → получает итоговое КП (структурированный JSON + ссылка на документ).

### Бизнес-логика (Business Layer)
   * Компонент	Назначение
   * LLM-Agent	Оркестратор, определяет сценарий обработки и маршрутизацию воркеров.
   * ParserWorker	Извлекает ключевые данные из заявки: компания, контакт, требуемые товары/услуги, количество, сроки.
   * OfferWorker	Использует LLM/VLLM для генерации коммерческого предложения в нужной структуре: описание, позиция, цена, условия.
   * ValidationWorker	Проверяет КП на ошибки, бизнес-правила (маржа, шаблон, формулировки), согласует с внутренней базой продуктов.


### Инфраструктура (Infrastructure Layer)

   * Очереди задач (jobs.parser, jobs.offer, jobs.validation) — асинхронная обработка.

   * Валидация и кэширование заявок (идемпотентность).

   * Сервис шифрования / OCR (если скан).

   * Поддержка нескольких моделей LLM (например, GPT-5, Claude, Mistral).

   * База данных для отслеживания состояния задач и результатов.


### Presentation Layer (Frontend / API)

   * API Gateway / Swagger — загрузка заявки, просмотр статуса, скачивание КП.

   * Dashboard (для менеджеров) — просмотр истории, ручная правка КП, повторный запуск анализа.


### Input JSON:
```json
{
  "UsingLLM": "GPT-5",
  "ClientRequest": "Письмо клиента или текст из PDF",
  "Attachments": ["offer_request.pdf"],
  "BusinessRules": "Шаблон КП, минимальная маржа 10%, согласованные бренды",
  "InternalCatalog": "База артикулов и цен",
  "Language": "ru"
}
```
### OutputJSON: 
```json 
{
  "Worker": "OfferWorker",
  "SubmissionId": 123,
  "Corrections": [
    {
      "CorrectionId": "UUID",
      "Step": "parse | match | generate | validate",
      "InputFragment": {
        "Field": "ProductName",
        "Content": "Сервер Dell 740"
      },
      "Suggestion": {
        "Text": "Dell PowerEdge R740, 32GB RAM, 2xCPU",
        "Severity": "info",
        "Category": "matching"
      }
    }
  ],
  "FinalOffer": {
    "OfferId": "UUID",
    "GeneratedAt": "2025-11-11T12:00:00Z",
    "DocumentLink": "https://storage/offers/123.pdf",
    "Summary": {
      "TotalAmount": 1240000,
      "Currency": "RUB",
      "Validity": "30 days"
    }
  }
}
```

### Юзкейсы
#### UC1 — Отправка запроса клиентом

* Как клиент / менеджер: отправляю входящее письмо / PDF → система автоматически обрабатывает его и формирует КП.

* Основной поток:

   * Клиент отправляет файл / текст.

   * API → сохраняет и инициирует задачу.

   * LLM-Agent решает: что это — письмо, текст, PDF.

   * ParserWorker извлекает данные.

   * OfferWorker генерирует КП.

   * ValidationWorker проверяет КП.

   * Сохраняется финальный результат + PDF.


#### UC2 — Перезапуск или коррекция КП

   * Как менеджер, я могу задать уточняющие критерии (маржа, стиль, шаблон).

   * POST /review/{submissionId} с параметрами:

       * "BusinessRules": "новый шаблон"

       * "Tone": "официальный / дружественный" 

   * Результат → обновлённое КП + версия в БД.


#### UC3 — Автоматический парсинг (ParserWorker)

   * Распознаёт текст и поля из PDF/email/сканов.

   * LLM + OCR → выделяет:

      * Название компании, контактное лицо.

      * Предмет запроса, количество, бюджет.

   * Передаёт в OfferWorker.


#### UC4 — Генерация КП (OfferWorker)

* Генерирует готовое КП на основе:

* Запроса клиента.

    * Каталога и бизнес-правил.

    * Стиля (официальный / креативный).

* Возвращает:

   * JSON-структуру с позициями и суммой.

   * Сформированный PDF/DOCX.

#### UC5 — Проверка КП (ValidationWorker)

* Проверяет:

   * Соответствие цен политике компании.

   * Формат КП (логотип, реквизиты, корректность дат).

* Возвращает список исправлений + итоговый статус.